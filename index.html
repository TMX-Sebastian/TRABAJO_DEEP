<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clasificador de platos (TF.js)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;margin:24px;line-height:1.35}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start}
    #preview{width:224px;height:224px;object-fit:cover;border:1px solid #ddd;border-radius:8px}
    button,input{font-size:16px;padding:10px 14px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button{background:#111;color:#fff;border-color:#111}
    #preds{margin-top:12px}
    progress{width:100%}
    .card{border:1px solid #eee;border-radius:12px;padding:16px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
</head>
<body>
  <h1>Clasificador de platos</h1>

  <div class="row">
    <div class="card">
      <input id="file" type="file" accept="image/*" />
      <div style="margin-top:10px;display:flex;gap:10px">
        <button id="predictBtn" disabled>Predecir</button>
        <span id="status">Cargando modelo…</span>
      </div>
      <div style="margin-top:10px"><progress id="bar" max="1" value="0" hidden></progress></div>
    </div>

    <div class="card">
      <img id="preview" alt="preview" />
      <canvas id="canvas" width="224" height="224" style="display:none"></canvas>
    </div>

    <div class="card" style="min-width:280px;flex:1">
      <h3>Predicciones</h3>
      <div id="preds">—</div>
    </div>
  </div>

  <script>
  const MODEL_URL = "./model.json";
  const LABELS_URL = "./labels.json";

  let model, labels;

  const fileEl = document.getElementById('file');
  const preview = document.getElementById('preview');
  const canvas = document.getElementById('canvas');
  const predictBtn = document.getElementById('predictBtn');
  const predsEl = document.getElementById('preds');
  const statusEl = document.getElementById('status');
  const bar = document.getElementById('bar');

  // --- utilidades ---
  function drawTo224(imgEl){
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,224,224);
    const [w,h] = [imgEl.naturalWidth || imgEl.videoWidth || imgEl.width,
                   imgEl.naturalHeight || imgEl.videoHeight || imgEl.height];
    // letterbox para mantener proporción
    const scale = Math.min(224 / w, 224 / h);
    const nw = Math.round(w * scale), nh = Math.round(h * scale);
    const dx = Math.round((224 - nw) / 2), dy = Math.round((224 - nh) / 2);
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,224,224);
    ctx.drawImage(imgEl, 0, 0, w, h, dx, dy, nw, nh);
  }

  function topK(arr, k=5){
    const idx = arr.map((v,i)=>[v,i]).sort((a,b)=>b[0]-a[0]).slice(0,k).map(x=>x[1]);
    return idx.map(i=>({i, p: arr[i]}));
  }

  async function loadAll(){
    // Carga modelo (layers-model) y etiquetas
    model = await tf.loadLayersModel(MODEL_URL);
    labels = await fetch(LABELS_URL).then(r=>r.json()).catch(()=>null);

    // Warmup para que la 1ª predicción sea rápida
    tf.tidy(()=> model.predict(tf.zeros([1,224,224,3])));

    statusEl.textContent = "Modelo listo.";
    predictBtn.disabled = false;
  }

  async function predict(){
    if (!preview.src) return;
    bar.hidden = false; bar.value = 0.1;
    statusEl.textContent = "Procesando…";

    // Dibuja a 224 y normaliza a [-1, 1] (quitamos Rescaling del modelo)
    drawTo224(preview);
    const input = tf.tidy(()=> 
      tf.browser.fromPixels(canvas)
        .toFloat()
        .div(255).mul(2).sub(1)   // [0,1] -> [-1,1]
        .expandDims(0)
    );

    const y = tf.tidy(()=> model.predict(input));
    const probs = Array.from(await y.data());
    input.dispose(); y.dispose();

    const top = topK(probs, Math.min(5, probs.length));
    predsEl.innerHTML = top.map(({i,p})=>{
      const name = labels?.[i] ?? `Clase ${i}`;
      const pct = (p*100).toFixed(2);
      return `<div><b>${name}</b>: ${pct}%</div>`;
    }).join("");
    bar.hidden = true;
    statusEl.textContent = "Listo.";
  }

  // --- eventos ---
  fileEl.addEventListener('change', e=>{
    const file = e.target.files?.[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    preview.onload = ()=> URL.revokeObjectURL(url);
    preview.src = url;
    predsEl.textContent = "—";
  });

  predictBtn.addEventListener('click', predict);

  loadAll();
  </script>
</body>
</html>
