<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clasificador de Platos Peruanos — Foto (Top-1 y Top-5)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root { --bg:#0b1020; --fg:#e7ecf3; --muted:#9fb1c2; --card:#121a33; --acc:#6ee7b7; }
    html,body{height:100%} body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial; background:var(--bg); color:var(--fg);}
    .wrap{max-width:900px; margin:0 auto; padding:16px;}
    .card{background:var(--card); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); margin-bottom:16px;}
    button{border:0; padding:10px 14px; border-radius:12px; background:#1f2a52; color:var(--fg); cursor:pointer;}
    button.primary{background:var(--acc); color:#08210c; font-weight:700;}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .hint{color:var(--muted); font-size:.95em}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";}
    img, canvas{max-width:100%; border-radius:12px;}
    input[type="file"]{display:none}
    .file-label{border:1px dashed #2b3a6b; padding:10px 14px; border-radius:10px; cursor:pointer;}
    .k{display:flex; justify-content:space-between; padding:8px 10px; background:#0e1631; border-radius:10px; margin-bottom:6px;}
    .bar{height:8px; background:#233060; border-radius:8px; overflow:hidden}
    .bar>span{display:block; height:100%; background:var(--acc)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Clasificador de Platos Peruanos — Foto</h1>
    <p class="hint">Carga tu modelo (Keras exportado a TF.js: <span class="mono">model.json + .bin</span>) y tus etiquetas (<span class="mono">labels.json</span>). Luego selecciona o toma una foto para obtener el <strong>Top-1</strong> y el <strong>Top-5</strong>.</p>

    <section class="card">
      <h2>1) Cargar modelo y etiquetas</h2>
      <div class="row">
        <label class="file-label">
          <input id="modelFiles" type="file" multiple accept=".json,.bin" />
          Cargar <strong>local</strong> (model.json + shards .bin)
        </label>
        <label class="file-label">
          <input id="labelsFile" type="file" accept=".json" />
          Cargar <strong>labels.json</strong>
        </label>
        <button id="btnLoad" class="primary">Cargar</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="modelUrl" class="mono" style="flex:1; padding:10px;border-radius:10px;border:1px solid #2b3a6b;background:#0e1631;color:var(--fg)" placeholder="https://tu-sitio.com/model/model.json">
        <input id="labelsUrl" class="mono" style="flex:1; padding:10px;border-radius:10px;border:1px solid #2b3a6b;background:#0e1631;color:var(--fg)" placeholder="https://tu-sitio.com/model/labels.json">
        <button id="btnLoadUrl">Cargar por URL</button>
      </div>
      <p id="status" class="hint">Modelo no cargado.</p>
    </section>

    <section class="card">
      <h2>2) Foto</h2>
      <div class="row">
        <label class="file-label">
          <input id="photo" type="file" accept="image/*" capture="environment" />
          Seleccionar/Tomar foto
        </label>
        <button id="btnPredict" class="">Predecir</button>
      </div>
      <img id="preview" alt="preview" />
      <canvas id="canvas" width="224" height="224" hidden></canvas>
    </section>

    <section class="card">
      <h2>Resultados</h2>
      <div id="single"></div>
      <div id="topk"></div>
    </section>
  </div>

<script>
  let model = null;
  let labels = [];
  const $ = (id)=>document.getElementById(id);
  const statusEl = $("status");
  const canvas = $("canvas");
  const ctx = canvas.getContext("2d");
  const preview = $("preview");

  function setStatus(msg){ statusEl.textContent = msg; }

  async function loadModelFromFiles(){
    const files = $("modelFiles").files;
    const labFile = $("labelsFile").files[0];
    if(!files || files.length === 0){ alert("Selecciona model.json y sus .bin"); return; }
    // Acomoda: model.json primero, luego shards
    const list = Array.from(files);
    const jsonFile = list.find(f=>f.name.endsWith(".json"));
    if(!jsonFile){ alert("Falta model.json"); return; }
    const binFiles = list.filter(f=>f.name.endsWith(".bin"));
    const ordered = [jsonFile, ...binFiles];
    setStatus("Cargando modelo (archivos locales)...");
    model = await tf.loadLayersModel(tf.io.browserFiles(ordered));
    setStatus("Modelo cargado ✔");

    if(labFile){
      const text = await labFile.text();
      labels = JSON.parse(text);
    } else {
      labels = [];
    }
  }

  async function loadModelFromUrls(){
    const murl = $("modelUrl").value.trim();
    const lurl = $("labelsUrl").value.trim();
    if(!murl){ alert("Ingresa la URL del model.json"); return; }
    setStatus("Cargando modelo (URL)...");
    model = await tf.loadLayersModel(murl);
    setStatus("Modelo cargado ✔");
    if(lurl){
      const res = await fetch(lurl);
      labels = await res.json();
    } else {
      labels = [];
    }
  }

  function drawTo224(img){
    // Redimensionar a 224x224, recorte centrado cuadrado
    const size = 224;
    canvas.width = size; canvas.height = size;
    const w = img.naturalWidth || img.videoWidth || img.width;
    const h = img.naturalHeight || img.videoHeight || img.height;
    const side = Math.min(w,h);
    const sx = (w - side)/2, sy = (h - side)/2;
    ctx.drawImage(img, sx, sy, side, side, 0, 0, size, size);
  }

  async function predict(){
    if(!model){ alert("Carga el modelo primero"); return; }
    if(!preview.src){ alert("Selecciona o toma una foto"); return; }
    drawTo224(preview);
    const input = tf.tidy(()=> tf.browser.fromPixels(canvas).expandDims(0) );
    // Tu modelo ya incluye el rescaling [-1,1] dentro del grafo, así que no normalizamos aquí.
    let y = model.predict(input);
    if(Array.isArray(y)) y = y[0];
    y = y.reshape([y.shape[y.shape.length-1]]); // [N]
    const probs = await y.data();
    y.dispose(); input.dispose();

    renderPreds(Array.from(probs));
  }

  function topK(arr, k=5){
    const ix = arr.map((v,i)=>[v,i]).sort((a,b)=>b[0]-a[0]).slice(0,k);
    return ix.map(([p,i])=>({ index:i, prob:p, label: labels[i] ?? `Clase ${i}`}));
  }
  function pct(x){ return (x*100).toFixed(1) + "%"; }

  function renderPreds(probs){
    const bestIdx = probs.indexOf(Math.max(...probs));
    const best = { index:bestIdx, prob:probs[bestIdx], label: labels[bestIdx] ?? `Clase ${bestIdx}` };
    $("single").innerHTML = `<h3>Top-1</h3><div class="k"><strong>${best.label}</strong><span>${pct(best.prob)}</span></div>`;

    const list = topK(probs, 5);
    const wrap = document.createElement("div");
    wrap.innerHTML = "<h3>Top-5</h3>";
    list.forEach(it=>{
      const row = document.createElement("div"); row.className = "k";
      row.innerHTML = `<span>${it.label}</span><span>${pct(it.prob)}</span>`;
      const bar = document.createElement("div"); bar.className = "bar";
      const span = document.createElement("span"); span.style.width = Math.round(it.prob*100) + "%";
      bar.appendChild(span);
      wrap.appendChild(row); wrap.appendChild(bar);
    });
    $("topk").innerHTML = ""; $("topk").appendChild(wrap);
  }

  // UI events
  $("btnLoad").onclick = loadModelFromFiles;
  $("btnLoadUrl").onclick = loadModelFromUrls;
  $("photo").onchange = (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const url = URL.createObjectURL(f); preview.src = url;
  };
  $("btnPredict").onclick = predict;
</script>
</body>
</html>
